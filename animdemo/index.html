<!DOCTYPE html>
<html>
  <head>
  <style type="text/css" rel="stylesheet">
  #pacman.up {
    transform: rotate(270deg);
  }
  #pacman.down {
    transform: rotate(90deg);
  }
  #pacman.left {
    transform: rotate(180deg);
  }
  #pacman.right {
    transform: rotate(0deg);
  }
  #score {
    text-align: center;
    text-transform: uppercase;
    font-size: 1.5em;
    font-weight: bold;
    width: 722px;
    margin: auto;
  }
  #stage {
    height: 800px;
    width: 722px;
    background: no-repeat url('background.png');
    margin: auto;
    position: relative;
  }

  </style>
  <script type="text/javascript" src="jquery-2.1.4.js"></script>
  <script type="text/javascript">
    /* ====================== Globals =================== */
    var bounds = [ 32, 24, 678, 749 ];
    score = 0;
    hiscore = 0;
    var speed = 2;
    var map = [
    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 2,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 2],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],

    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1],

    [-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 0,-1,-1, 0,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 0,-1,-1, 0,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],

    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],

    [ 2, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 2],
    [-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1],
    [-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1],

    [ 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1],
    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    ];

    /* ====================== Character ================= */
    function Character(x, y, ele) {
      this.element = $(ele);
      this.x = x;
      this.y = y;
      this.dx = 0;
      this.dy = 0;
      this.offsetx = this.element.width()  / 2;
      this.offsety = this.element.height() / 2;
      return this;
    }

    Character.prototype.move = function(x, y) {
      this.x += x;
      this.y += y;
      this.dx = x;
      this.dy = y;
    }

    Character.prototype.mapX = function() {
      return Math.round((this.x - bounds[0]) / 26)
    }

    Character.prototype.mapY = function() {
      return Math.round((this.y - bounds[1]) / 26)
    }

    Character.prototype.update = function() {
      this.element.removeClass();
      if (this.dx < 0)
        this.element.addClass('left');
      if (this.dx > 0)
        this.element.addClass('right');
      if (this.dy < 0)
        this.element.addClass('up');
      if (this.dy > 0)
        this.element.addClass('down');
      this.element.css({ 
        'left': this.x - this.offsetx  / 2,
        'top' : this.y - this.offsety / 2,
      });
    }

    /* ====================== Input ===================== */

    function Input(up, down, left, right) {
      if (up)
        this.up = up;
      if (down)
        this.down = down;
      if (left)
        this.left = left;
      if (right)
        this.right = right;
      return this;
    }

    Input.prototype.keys = {};
    Input.prototype.up    = 38;
    Input.prototype.down  = 40;
    Input.prototype.left  = 37;
    Input.prototype.right = 39;

    Input.prototype.filter = function(coords) {
      return this.keys; // temporary
//      var returnvalue = {}
//      returnvalue.up    = this.keys.up;
//      returnvalue.down  = this.keys.down;
//      returnvalue.left  = this.keys.left;
//      returnvalue.right = this.keys.right;
//      if (!((coords.x - 36) % 26)) {
//        returnvalue.up = false;
//        returnvalue.down = false;
//      }
//      if (!((coords.y - 34) % 26)) {
//        returnvalue.left = false;
//        returnvalue.right = false;
//      }
//      return returnvalue;
    }

    Input.prototype.pressed = function(pressed) {
      if (pressed == this.up)
        this.keys.up    = true;
      if (pressed == this.down)
        this.keys.down  = true;
      if (pressed == this.left)
        this.keys.left  = true;
      if (pressed == this.right)
        this.keys.right = true;
    }

    Input.prototype.released = function(released) {
      if (released == this.up)
        this.keys.up    = false;
      if (released == this.down)
        this.keys.down  = false;
      if (released == this.left)
        this.keys.left  = false;
      if (released == this.right)
        this.keys.right = false;
    }

    /* ==================== Map ========================= */

    function Map(map) {
      this.map = map;
      return this;
    }

    Map.prototype.draw = function() {
      var pellet = $('<img src="pellet.png" style="position:absolute;">');
      var ppellet = $('<img src="powerpellet.png" style="position:absolute;">');
      var pacsprite = $('#pacman')
      for (i in this.map) {
        for (j in this.map[i]) {
          if (this.map[i][j] == 1) {
            var newPellet = pellet.clone();
            newPellet.css({'top': i * 26 + 19, 'left': j * 26 + 25 });
            this.map[i][j] = newPellet;
            newPellet.insertAfter(pacsprite);
          }
          if (this.map[i][j] == 2) {
            var newPellet = ppellet.clone();
            newPellet.css({'top': i * 26 + 19, 'left': j * 26 + 25 });
            this.map[i][j] = newPellet;
            newPellet.insertAfter(pacsprite);
          }
        }
      }
    }

    Map.prototype.eat = function(pacman) {
      var scoreadd = 0;
      var i = pacman.mapX()
      var j = pacman.mapY()
      if (this.map[j][i].remove) {       // if this is a pellet
        if (this.map[j][i].attr("src") == "pellet.png")
          scoreadd = 10;
        else
          scoreadd = 50;
        this.map[j][i].remove();
        this.map[j][i] = 0;
      }
      return scoreadd;
    }

    function updateScore(score) {
      if (score > hiscore) {
        hiscore = score;
        $("#hiscore").text(hiscore);
      }
      $("#1upscore").text(score);
    }

    /* ================== Mainloop ====================== */

    function mainloop() {
      var keys = input.filter(pacman);
      var dx=0, dy=0;
      if (keys.up) {
        dy -= speed;
      } else if (keys.down) {
        dy += speed;
      } else {
        if (keys.left) {
          dx -= speed;
        } else if (keys.right) {
          dx += speed;
        } else { }
      } 
      if (dx || dy)
        pacman.move(dx, dy);

      score += stage.eat(pacman);
      updateScore(score);

      // temporary code
      if (pacman.x < bounds[0]) pacman.x = bounds[0];
      if (pacman.y < bounds[1]) pacman.y = bounds[1];
      if (pacman.x > bounds[2]) pacman.x = bounds[2];
      if (pacman.y > bounds[3]) pacman.y = bounds[3];

      /* temporary ghost code */
      if (blinky.dx > 0) {
        if (blinky.x < 460)
          blinky.move(1, 0);
        else
          blinky.move(-1, 0);
      } else {
        if (blinky.x > 240)
          blinky.move(-1, 0);
        else
          blinky.move(1, 0);
      }

      var ghosts = [inky, pinky, clyde];
      for (i in ghosts) {
        if (ghosts[i].dy > 0) {
          if (ghosts[i].y < 376)
            ghosts[i].move(0, 1);
          else
            ghosts[i].move(0, -1);
        } else {
          if (ghosts[i].y > 344)
            ghosts[i].move(0, -1);
          else
            ghosts[i].move(0, 1);
        }
      }
      
      if (blinky.dx > 0) {
        if (blinky.x < 460)
          blinky.move(2, 0);
        else
          blinky.move(-2, 0);
      } else {
        if (blinky.x > 240)
          blinky.move(-2, 0);
        else
          blinky.move(2, 0);
      }

      /* end temporary ghost code */

      update();

    }

    function update() {
      pacman.update();
      inky.update();
      blinky.update();
      pinky.update();
      clyde.update();
    }


    window.onload = function() {
      input = new Input();
      pacman = new Character( 352, 594, '#pacman', true);
      inky   = new Character( 300, 360, '#inky');
      blinky = new Character( 352, 282, '#blinky');
      pinky  = new Character( 352, 360, '#pinky');
      pinky.dy = 1; // temporary
      clyde  = new Character( 403, 360, '#clyde');
      stage = new Map(map);
      stage.draw();
      window.addEventListener('keydown', function(event) { input.pressed(event.keyCode); }, false);
      window.addEventListener('keyup', function(event) { input.released(event.keyCode); }, false);
      setInterval(mainloop, 10);
    }
  </script>
  </head>
  <body style="background-color: black; color: white;">
  <div id="score" style="">
    <div id="1upScoreContainer" style="float:left;">
      1 UP<br><span id="1upscore">0</span>
    </div>
    HI SCORE <br><span id="hiscore">0</span>
  </div>
  <div id="stage" style="">
    <img id="inky"   src="inky.png" style="position: absolute; left:0px; top:0px;">
    <img id="blinky" src="blinky.png" style="position: absolute; left:0px; top:0px;">
    <img id="pinky"  src="pinky.png" style="position: absolute; left:0px; top:0px;">
    <img id="clyde"  src="clyde.png" style="position: absolute; left:0px; top:0px;">
    <img id="pacman" src="pacman.gif" style="position: absolute; left:0px; top:0px;">
  </div>
  <div style="position: fixed; width: 200px; top: 0px; right: 0px">
    Use the arrow keys to move.
  </div>
  </body>
</html>
