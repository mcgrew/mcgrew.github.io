<!DOCTYPE html>
<html>
  <head>
  <style type="text/css" rel="stylesheet">
  #pacman.up {
    transform: rotate(270deg);
  }
  #pacman.down {
    transform: rotate(90deg);
  }
  #pacman.left {
    transform: rotate(180deg);
  }
  #pacman.right {
    transform: rotate(0deg);
  }

  .ghost, .ghost img {
    position: absolute;
    top: 0px;
    left: 0px;
    height: 46px;
    width: 46px;
  }
  .ghost .up, .ghost .down, .ghost .left, .ghost .right {
    display: none;
  }
  .ghost.up .up {
    display: block;
  }
  .ghost.down .down {
    display: block;
  }
  .ghost.left .left {
    display: block;
  }
  .ghost.right .right {
    display: block;
  }


  #score {
    text-align: center;
    text-transform: uppercase;
    font-size: 1.5em;
    font-weight: bold;
    width: 722px;
    margin: auto;
  }
  #stage {
    height: 800px;
    width: 722px;
    background: no-repeat url('background.png');
    margin: auto;
    position: relative;
  }

  </style>
  <script type="text/javascript" src="jquery-2.1.4.js"></script>
  <script type="text/javascript">
    /* ====================== Globals =================== */
    sound = {
      chomp: [ new Audio("sound/chomp1.wav"), new Audio("sound/chomp2.wav") ]
    }
    var bounds = [ 28, 22, 678, 750 ];
    var gridSize = 26;
    score = 0;
    hiscore = 0;
    var speed = 2;
    var map = [
    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 2,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 2],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],

    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1],

    [-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 0,-1,-1, 0,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 0,-1,-1, 0,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [ 0, 0, 0, 0, 0, 1, 0, 0, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],
    [-1,-1,-1,-1,-1, 1,-1,-1, 0,-1,-1,-1,-1,-1,-1,-1,-1, 0,-1,-1, 1,-1,-1,-1,-1,-1],

    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1, 1,-1,-1,-1,-1, 1],

    [ 2, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 2],
    [-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1],
    [-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1, 1,-1,-1],

    [ 1, 1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1,-1,-1, 1, 1, 1, 1, 1, 1],
    [ 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1],
    [ 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1, 1],
    [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
    ];

    /* ====================== Character ================= */
    function Character(x, y, ele) {
      this.element = $(ele);
      this.x = x;
      this.y = y;
      this.dx = 0;
      this.dy = 0;
      this.offsetx = this.element.width()  / 2;
      this.offsety = this.element.height() / 2;
      return this;
    }

    Character.prototype.move = function(x, y) {
      this.x += x;
      this.y += y;
      this.dx = x;
      this.dy = y;
    }

    Character.prototype.mapX = function() {
      return Math.round((this.x - bounds[0]) / gridSize)
    }

    Character.prototype.mapY = function() {
      return Math.round((this.y - bounds[1]) / gridSize)
    }

    Character.prototype.update = function() {
      this.element.removeClass('up down left right');
      if (this.dx < 0)
        this.element.addClass('left');
      if (this.dx > 0)
        this.element.addClass('right');
      if (this.dy < 0)
        this.element.addClass('up');
      if (this.dy > 0)
        this.element.addClass('down');
      this.element.css({ 
        'left': this.x - this.offsetx  / 2,
        'top' : this.y - this.offsety / 2,
      });
    }

    /* ====================== Input ===================== */

    function Input(character, map, up, down, left, right) {
      this.character = character;
      this.map = map;
      if (up)
        this.up = up;
      if (down)
        this.down = down;
      if (left)
        this.left = left;
      if (right)
        this.right = right;
      return this;
    }

    Input.prototype.keys = 0;
    Input.prototype.lastKeys = 0;
    Input.prototype.up    = 38;
    Input.prototype.down  = 40;
    Input.prototype.left  = 37;
    Input.prototype.right = 39;

    Input.prototype.filter = function(input, alt) {
      if (input === undefined) {
        input = this.keys;
        alt = this.lastKeys;
      }
      var filteredKeys = input  
      var moves = this.map.validMoves(this.character.mapX(), this.character.mapY());
      if ((this.character.x - bounds[0]) % gridSize) {
        filteredKeys &= 3;
        moves |= 3;
      }
      if ((this.character.y - bounds[1]) % gridSize) {
        filteredKeys &= 12
        moves |= 12;
      }
      filteredKeys &= moves;
      if (!filteredKeys && alt)
        return this.filter(alt)
      return filteredKeys;
    }

    Input.prototype.pressed = function(pressed) {
      var keys = this.keys;
      if (pressed == this.up)
        keys |= 8;
      if (pressed == this.down)
        keys |= 4;
      if (pressed == this.left)
        keys |= 2;
      if (pressed == this.right)
        keys |= 1;

      if (keys != this.keys) {
        if (this.filter(this.keys)) 
          this.lastKeys = this.keys;
        this.keys = keys;
      }
    }

    Input.prototype.released = function(released) {
      var keys = this.keys;
      if (released == this.up)
        keys &= 7;
      if (released == this.down)
        keys &= 11;
      if (released == this.left)
        keys &= 13;
      if (released == this.right)
        keys &= 14;

      if (keys != this.keys) {
        if (this.filter(this.keys)) 
          this.lastKeys = this.keys;
        this.keys = keys;
      }
    }

    /* ==================== Map ========================= */

    function Map(map) {
      this.map = map;
      this.buildIndex();
      return this;
    }

    Map.prototype.draw = function() {
      var pellet = $('<img src="pellet.png" style="position:absolute;">');
      var ppellet = $('<img src="powerpellet.png" style="position:absolute;">');
      var pacsprite = $('#pacman')
      for (i in this.map) {
        for (j in this.map[i]) {
          if (this.map[i][j] == 1) {
            var newPellet = pellet.clone();
            newPellet.css({'top': i * gridSize + 19, 'left': j * gridSize + 25 });
            this.map[i][j] = newPellet;
            newPellet.insertAfter(pacsprite);
          }
          if (this.map[i][j] == 2) {
            var newPellet = ppellet.clone();
            newPellet.css({'top': i * gridSize + 19, 'left': j * gridSize + 25 });
            this.map[i][j] = newPellet;
            newPellet.insertAfter(pacsprite);
          }
        }
      }
    }

    Map.prototype.eat = function(pacman) {
      var scoreadd = 0;
      var i = pacman.mapX()
      var j = pacman.mapY()
      if (this.map[j][i].remove) {       // if this is a pellet
        chompSound();
        if (this.map[j][i].attr("src") == "pellet.png")
          scoreadd = 10;
        else
          scoreadd = 50;
        this.map[j][i].remove();
        this.map[j][i] = 0;
      }
      return scoreadd;
    }

    Map.prototype.isPassable = function(x, y) {
      return this.map(y, x) >= 0;
    }

    Map.prototype.buildIndex = function() {
      this.index = []
      for (var i=0; i < this.map.length; i++) {
        this.index.push([]);
        for (var j=0; j < this.map[i].length; j++) {
          var moves = 0;
          if (i > 0 && this.map[i-1][j] != -1) {
            moves |= 8;
          }
          if (i < this.map.length-1 && this.map[i+1][j] != -1) {
            moves |= 4;
          }
          if (j > 0 && this.map[i][j-1] != -1) {
            moves |= 2;
          }
          if (j < this.map[i].length-1 && this.map[i][j+1] != -1) {
            moves |= 1;
          }
          this.index[i].push(moves);
        }
      }
    }

    Map.prototype.validMoves = function(x, y) {
      return this.index[y][x];
    }

    /* ================ Random functions ================ */

    function updateScore(score) {
      if (score > hiscore) {
        hiscore = score;
        $("#hiscore").text(hiscore);
      }
      $("#1upscore").text(score);
    }

    function chompSound() {
      if (sound.chomp[0].canPlayType('audio/wav'))
        sound.chomp[Math.round(score/10) % 2].play();
    }

    /* ================== Main loop ===================== */

    function mainloop() {
      var keys = input.filter();
      var dx=0, dy=0;
      if (keys & 8) {
        dy -= speed;
      } else if (keys & 4) {
        dy += speed;
      } else {
        if (keys & 2) {
          dx -= speed;
        } else if (keys & 1) {
          dx += speed;
        } else { }
      } 
      if (dx || dy)
        pacman.move(dx, dy);

      score += stage.eat(pacman);
      updateScore(score);

      // temporary code
      if (pacman.x < bounds[0]) pacman.x = bounds[0];
      if (pacman.y < bounds[1]) pacman.y = bounds[1];
      if (pacman.x > bounds[2]) pacman.x = bounds[2];
      if (pacman.y > bounds[3]) pacman.y = bounds[3];

      /* temporary ghost code */
      if (blinky.dx > 0) {
        if (blinky.x < 460)
          blinky.move(1, 0);
        else
          blinky.move(-1, 0);
      } else {
        if (blinky.x > 240)
          blinky.move(-1, 0);
        else
          blinky.move(1, 0);
      }

      var ghosts = [inky, pinky, clyde];
      for (i in ghosts) {
        if (ghosts[i].dy > 0) {
          if (ghosts[i].y < 376)
            ghosts[i].move(0, 1);
          else
            ghosts[i].move(0, -1);
        } else {
          if (ghosts[i].y > 344)
            ghosts[i].move(0, -1);
          else
            ghosts[i].move(0, 1);
        }
      }
      
      if (blinky.dx > 0) {
        if (blinky.x < 460)
          blinky.move(2, 0);
        else
          blinky.move(-2, 0);
      } else {
        if (blinky.x > 240)
          blinky.move(-2, 0);
        else
          blinky.move(2, 0);
      }

      /* end temporary ghost code */

      update();

    }

    function update() {
      pacman.update();
      inky.update();
      blinky.update();
      pinky.update();
      clyde.update();
    }


    window.onload = function() {
      pacman = new Character( bounds[0] + 320, bounds[1] + 572, '#pacman', true);
      inky   = new Character( 300, 360, '#inky');
      blinky = new Character( 352, 282, '#blinky');
      pinky  = new Character( 352, 360, '#pinky');
      pinky.dy = 1; // temporary
      clyde  = new Character( 403, 360, '#clyde');
      stage = new Map(map);
      input = new Input(pacman, stage);
      stage.draw();
      window.addEventListener('keydown', function(event) { input.pressed(event.keyCode); }, false);
      window.addEventListener('keyup', function(event) { input.released(event.keyCode); }, false);
      setInterval(mainloop, 10);
    }
  </script>
  </head>
  <body style="background-color: black; color: white;">
  <div id="score" style="">
    <div id="1upScoreContainer" style="float:left;">
      1UP<br><span id="1upscore">0</span>
    </div>
    HI SCORE <br><span id="hiscore">0</span>
  </div>
  <div id="stage" style="">
    <div class="ghost" id="inky">
      <img class="sprite" src="inky.gif">
      <img class="sprite up" src="eyes-up.png">
      <img class="sprite down" src="eyes-down.png">
      <img class="sprite left" src="eyes-left.png">
      <img class="sprite right" src="eyes-right.png">
    </div>
    <div class="ghost" id="blinky">
      <img class="sprite" src="blinky.gif">
      <img class="sprite up" src="eyes-up.png">
      <img class="sprite down" src="eyes-down.png">
      <img class="sprite left" src="eyes-left.png">
      <img class="sprite right" src="eyes-right.png">
    </div>
    <div class="ghost" id="pinky">
      <img class="sprite" src="pinky.gif">
      <img class="sprite up" src="eyes-up.png">
      <img class="sprite down" src="eyes-down.png">
      <img class="sprite left" src="eyes-left.png">
      <img class="sprite right" src="eyes-right.png">
    </div>
    <div class="ghost" id="clyde">
      <img class="sprite" src="clyde.gif">
      <img class="sprite up" src="eyes-up.png">
      <img class="sprite down" src="eyes-down.png">
      <img class="sprite left" src="eyes-left.png">
      <img class="sprite right" src="eyes-right.png">
    </div>
    <img id="pacman" src="pacman.gif" style="position: absolute; left:0px; top:0px;">
  </div>
  <div style="position: fixed; width: 200px; top: 0px; right: 0px">
    Use the arrow keys to move.
  </div>
  </body>
</html>
